<?php
use UnifiedUI\Module as UI,
	View\Partial\Partial;

/* @var $ui \UnifiedUI\Module */
$ui = $this->app->unifiedUI();

/* @var $request \Request\Module */
$request = $this->app->request();

/* @var $router \Router\Module */
$router = $this->app->router();

/* @var $exception \Exception */
$exception = $this->get("exception");
?>
<!DOCTYPE html>
<html ng-app="bliss" ng-controller="bliss.AppCtrl" class="{{app.unifiedui.theme.className}}">
	<head>
		<base href="<?=BASE_URL?>">
		<meta charset="utf-8">
		<meta name="fragment" content="!">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
		<meta name="mobile-web-app-capable" content="yes">
		
		<title ng-bind="pageTitle()"></title>
		
		<link rel="import" href="./polymer/bower_components/polymer/polymer.html">
		<link rel="import" href="./polymer/bower_components/core-icons/core-icons.html">
		<link rel="import" href="./polymer/bower_components/core-icons/social-icons.html">
		<link rel="import" href="./polymer/bower_components/paper-icon-button/paper-icon-button.html">
		<link rel="import" href="./polymer/bower_components/paper-spinner/paper-spinner.html">
		
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:500,300,700,400">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="./assets/all.css">
	</head>
	<body ng-controller="unifiedUI.LayoutCtrl" ng-class="{ready:app.ready}">
		<header id="header" class="shadow">
			<paper-icon-button icon="menu" class="menuToggle" ng-click="toggleMenu()" ng-class="{active:menuOpen}"></paper-icon-button>
			
			<aside class="widgets">
				<?=$ui->renderInjectables(UI::AREA_HEADER_WIDGETS)?>
			</aside>
			
			<h1 class="brand" title="{{app.name}}">
				<a href="./" ng-bind="app.name"></a>
			</h1>
			<h4 class="page-title" ng-if="page">{{page.title}}</h4>
		</header>
		
		<nav id="menu" class="shadow z2" ng-class="{open:menuOpen}">
			<?=$ui->renderInjectables(UI::AREA_MENU)?>
		</nav>
		<div id="menuOverlay" ng-click="toggleMenu()" ng-class="{visible:menuOpen}"></div>
		
		<div id="pageError" class="alert alert-danger shadow" ng-class="{visible:pageError}">
			<paper-icon-button icon="close" ng-click="clearPageError()"></paper-icon-button>
			<p>
				{{pageError.message}}
				&nbsp;
			</p>
		</div>
		
<?php if (!$exception): ?>
		<div id="pageLoading" class="block shadow z2" ng-class="{'visible':app.loading}">
			<section class="section body">
				<paper-spinner active></paper-spinner>
			</section>
		</div>
		
		<div id="content">
			<div ng-view></div>
		</div>
<?php else: ?>
		<article class="block shadow">
			<section class="section body">
				<?=$this->contents()?>
			</section>
		</article>
<?php endif; ?>
		
		
		
<?php
// Attempt to pre-load the view
try {
	$uri = $request->uri();
	if (!strlen($uri)) {
		$uri = "index";
	}
	$route = $router->find("{$uri}.html");
	$module = $this->app->module($route->module());
	$viewPath = $route->module() ."/". $route->controller() ."/". $route->action() .".html";
	$filename = $module->resolvePath("views/". $route->controller() ."/". $route->action() .".html.phtml");
	$partial = new Partial($filename);
	$contents = $partial->render();
?>
		<script type="text/ng-template" id="./<?=$viewPath?>"><?=$contents;?></script>
<?php
} catch (\Exception $e) {
	echo "\n<!--\n";
	echo "Could not pre-load template for '{$uri}.html'\n";
	echo "Message: ". $e->getMessage() ."\n";
	echo "-->\n";
}
?>
	
		
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0/angular.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0/angular-route.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0/angular-resource.min.js"></script>
		<script src="./assets/all.js"></script>
		<script>
			bliss.app = <?=json_encode($this->app->toArray())?>;
		</script>
	</body>
</html>